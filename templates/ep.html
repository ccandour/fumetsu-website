{% extends "base_sidebar.html" %}
{% load crispy_forms_filters %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{series.name_english}}, Odcinek {{odc_html|floatformat}} - Fumetsu{% endblock title %}
{% block meta %}
    <meta name="description" content="{{series.name_english}}, Odcinek {{odc_html|floatformat}} - Oglądaj online z napisami PL.">
{% endblock %}

{% block content %}
<div class="d-flex flex-column gap-4">
    <!-- Title and Episode Navigation -->
    <div class="d-flex flex-column align-items-center">
        <a href="{% url 'anime-nm' series.web_name %}"><h2>{{series.name_english}}</h2></a>
        <h5>
            {% if prev %}
                <a class="ps-4" href="{% url 'ep-nm' prev.key_map.web_name prev.ep_nr %}"><i class="fas fa-chevron-left"></i></a>
            {% else %}
                <i class="fas fa-chevron-left control-disabled ps-4"></i>
            {% endif %}
             Odcinek {{odc_html|floatformat}}
            {% if next %}
                <a class="pe-4" href="{% url 'ep-nm' next.key_map.web_name next.ep_nr %}"><i class="fas fa-chevron-right"></i></a>
            {% else %}
                <i class="fas fa-chevron-right control-disabled pe-4"></i>
            {% endif %}
         </h5>
    </div>

    <!-- Tabs -->
    <div class="card">
        <div class="card-body">
            <!-- Tab controls -->
            <nav>
                <div class="nav nav-justified nav-tabs px-5 gap-3" id="js-tabs-2" role="tablist">
                    {% for player in link %}
                        {% if forloop.counter == 1 %}
                        <button class="nav-link active player-btn fw-bold fs-5 py-2" id="nav-{{player.website}}-tab" data-bs-toggle="tab" data-bs-target="#nav-{{player.website}}" type="button" role="tab" aria-controls="nav-{{player.website}}" aria-selected="true">{{player.website}}</button>
                        {% else %}
                        <button class="nav-link player-btn fw-bold fs-5 py-2" id="nav-{{player.website}}-tab" data-bs-toggle="tab" data-bs-target="#nav-{{player.website}}" type="button" role="tab" aria-controls="nav-{{player.website}}" aria-selected="false">{{player.website}}</button>
                        {% endif %}
                    {% endfor %}
                </div>
            </nav>
            <!-- Tab content (players) -->
            <div class="tab-content rounded-3 bg-body-secondary mt-3" style="aspect-ratio: 16 / 9" id="js-tabs-content-2">
                {% for player in link %}
                    {% if forloop.counter == 1 %}
                    <div class="tab-pane active" id="nav-{{player.website}}" role="tabpanel" aria-labelledby="nav-{{player.website}}-tab" tabindex="0">
                        <div class="">
                            <div class="video_cont">
                                <iframe src="{{player.link}}" allowfullscreen></iframe>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="tab-pane fade" id="nav-{{player.website}}" role="tabpanel" aria-labelledby="nav-{{player.website}}-tab" tabindex="0">
                        <div class="">
                            <div class="video_cont">
                                <iframe src="{{player.link}}" allowfullscreen></iframe>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Subtitles -->
    {% if subtitles and user.is_authenticated %}
    <div class="d-flex flex-row justify-content-center">
        <button class="btn fw-bold btn-lg btn-secondary" value="-">
            <i class="fa-solid fa-arrow-down me-1" style="color: #ffffff;"></i>
            <a class="text-white" href="/media/{{subtitles}}" download="/media/{{subtitles}}">Pobierz napisy</a>
        </button>
    </div>
    {% endif %}

    <!-- Comments -->
    {% if user.is_authenticated or comment %}
    <div class="card">
        <div class="card-header d-flex flex-row align-items-center">
            <h4 class="card-title mb-0 py-1">Sekcja komentarzy:</h4>
        </div>
        <div class="card-body d-flex flex-column gap-4">
            {% if user.is_authenticated %}
            <form method="POST">
                {% csrf_token %}
                {{ comment_form|crispy }}
                <button class="btn btn-success flex-row d-flex align-items-center gap-2" type="submit">
                    <i class="fa-solid fa-check" style="color: #ffffff;"></i>
                    Dodaj
                </button>
            </form>
            {% endif %}
            {% if comment %}
            <div class="d-flex flex-column gap-4">
                {% for com in comment %}
                    <div class="d-flex flex-row align-items-start">
                        <a href="{% url 'profile' com.author.username %}" style="color:{{com.color}}">
                            <img class="com_img me-3 mt-1" src="{{ com.author.profile.image.url }}" alt="User Avatar">
                        </a>

                        <div class="d-flex flex-column">
                            <div class="d-flex flex-row gap-2 align-items-center">
                                <a href="{% url 'profile' com.author.username %}" style="color:{{com.color}}">
                                    <div class="fs-5 fw-semibold">{{com.author.username}}</div>
                                </a>

                            <span class="d-none d-md-block">
                                {{com.date_posted|date:"d.m.o"}}
                            </span>

                                {% if com.author == user %}
                                <div class="dropend float-end ms-0">
                                    <a class="com_mor" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="fa-solid fa-ellipsis-vertical fa-md text-primary-emphasis pe-2" aria-hidden="true"></i>
                                    </a>
                                    <div class="dropdown-menu ms-2 p-0" style="min-width: 100px" aria-labelledby="navbarDropdown">
                                        <button onclick="location.href='{% url 'edit-cmt' com.id %}'" class="d-flex flex-row align-items-center gap-2 btn btn-outline-success rounded-bottom-0 w-100">
                                            <i class="fa-solid fa-pen fa-sm"></i>
                                            Edytuj
                                        </button>
                                        <form method="POST" action="{% url 'del-cmt' com.id %}">
                                            {% csrf_token %}
                                            <button class="d-flex flex-row align-items-center gap-2 btn btn-outline-danger rounded-top-0 w-100">
                                                <i class="fa-solid fa-trash fa-sm"></i>
                                                Usuń
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {{com.content}}
                            <input type="hidden" name="idd" value="{{com.pk}}" class="pdk">
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock content %}
